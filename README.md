# Kon-Agent

ä¸€ä¸ªé«˜æ€§èƒ½çš„è¾¹ç¼˜è®¡ç®—ç›‘æ§ä»£ç†ï¼Œä½¿ç”¨Goè¯­è¨€å¼€å‘ï¼Œæ”¯æŒeBPFç½‘ç»œç›‘æ§å’ŒQUICåè®®ä¼ è¾“ã€‚

## ç‰¹æ€§

- ğŸ” **å®æ—¶ç›‘æ§**: æ”¯æŒCPUä½¿ç”¨ç‡ã€ç½‘ç»œæµé‡ç­‰æŒ‡æ ‡é‡‡é›†
- ğŸš€ **é«˜æ€§èƒ½ä¼ è¾“**: åŸºäºQUICåè®®å®ç°ä½å»¶è¿Ÿã€é«˜ååé‡çš„æ•°æ®ä¼ è¾“
- ğŸ”’ **å®‰å…¨å¯é **: æ”¯æŒæƒé™é™çº§å’Œå®‰å…¨çš„ç½‘ç»œé€šä¿¡
- ğŸ“Š **æ’ä»¶æ¶æ„**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒåŠ¨æ€åŠ è½½å’Œå¸è½½ç›‘æ§æ’ä»¶
- ğŸ›¡ï¸ **eBPFæ”¯æŒ**: ä½¿ç”¨eBPFæŠ€æœ¯å®ç°å†…æ ¸çº§åˆ«çš„ç½‘ç»œç›‘æ§
- ğŸ’¾ **ç¼“å­˜æœºåˆ¶**: å†…ç½®ç¯å½¢ç¼“å†²åŒºï¼Œæ”¯æŒæ–­ç½‘é‡è¿å’Œæ•°æ®æŒä¹…åŒ–

## æ¶æ„æ¦‚è§ˆ

```
Kon-Agent
â”œâ”€â”€ cmd/edge-agent/          # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ internal/               # å†…éƒ¨æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ config/            # é…ç½®åŠ è½½å’ŒéªŒè¯
â”‚   â”œâ”€â”€ edge-agent/        # æ ¸å¿ƒä»£ç†é€»è¾‘
â”‚   â”œâ”€â”€ plugin/            # æ’ä»¶ç®¡ç†ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ network/ebpf/  # eBPFç½‘ç»œç›‘æ§æ’ä»¶
â”‚   â”‚   â””â”€â”€ system/cpu/    # CPUç›‘æ§æ’ä»¶
â”‚   â”œâ”€â”€ security/          # å®‰å…¨ç›¸å…³åŠŸèƒ½
â”‚   â”œâ”€â”€ transport/         # æ•°æ®ä¼ è¾“å±‚
â”‚   â”‚   â”œâ”€â”€ buffer/        # ç¯å½¢ç¼“å†²åŒºç®¡ç†
â”‚   â”‚   â””â”€â”€ quic/          # QUICå®¢æˆ·ç«¯å®ç°
â”‚   â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
â”œâ”€â”€ pkg/                   # å…¬å…±åŒ…
â”‚   â”œâ”€â”€ plugin/            # æ’ä»¶æ¥å£å®šä¹‰
â”‚   â””â”€â”€ protocol/          # Protobufåè®®å®šä¹‰
â”œâ”€â”€ configs/               # é…ç½®æ–‡ä»¶
â”œâ”€â”€ scripts/              # æ„å»ºè„šæœ¬
â””â”€â”€ server/              # æµ‹è¯•ç”¨ç¤ºä¾‹æœåŠ¡å™¨
```

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Go 1.24+
- Clangå’ŒLLVMï¼ˆç”¨äºç¼–è¯‘eBPFç¨‹åºï¼‰
- Linuxå†…æ ¸æ”¯æŒeBPFï¼ˆæ¨è5.8+ï¼‰

### å®‰è£…ä¾èµ–

```bash
# å®‰è£…ç³»ç»Ÿä¾èµ–
sudo apt-get update
sudo apt-get install -y clang llvm

# å®‰è£…Goä¾èµ–
go mod download
```

### æ„å»ºeBPFç¨‹åº

```bash
# ç¼–è¯‘eBPFç›‘æ§ç¨‹åº
./scripts/build_ebpf.sh
```

### æ„å»ºå’Œè¿è¡Œä»£ç†

```bash
# æ„å»ºä¸»ç¨‹åº
CGO_ENABLED=1 CC=clang go build -o edge-agent ./cmd/edge-agent/main.go

# è¿è¡Œä»£ç†ï¼ˆéœ€è¦rootæƒé™ç”¨äºeBPFï¼‰
sudo ./kon-agent -config configs/agent.yaml
```

### è¿è¡Œç¤ºä¾‹æœåŠ¡å™¨

```bash
# è¿è¡Œæµ‹è¯•ç”¨QUICæœåŠ¡å™¨
go run ./server/main/quic_server.go
```

## é…ç½®è¯´æ˜

### ä»£ç†é…ç½® (configs/agent.yaml)

```yaml
server: "quic://localhost:7843"
client-id: "edge-agent-1"
plugins:
  cpu:
    enable: true
    period: 5s
  ebpf:
    enable: true
    period: 5s
cache:
  path: /tmp/edge_agent.cache
  max_size: 50MB
```

### é…ç½®å­—æ®µè¯´æ˜

- `server`: QUICæœåŠ¡å™¨åœ°å€ï¼Œæ ¼å¼ä¸º `quic://host:port`
- `client-id`: å®¢æˆ·ç«¯æ ‡è¯†ç¬¦
- `plugins`: æ’ä»¶é…ç½®
  - `enable`: æ˜¯å¦å¯ç”¨æ’ä»¶
  - `period`: æ•°æ®é‡‡é›†é—´éš”
- `cache`: ç¼“å­˜é…ç½®
  - `path`: çŠ¶æ€ç¼“å­˜æ–‡ä»¶è·¯å¾„
  - `max_size`: æœ€å¤§ç¼“å­˜å¤§å°

## æ’ä»¶ç³»ç»Ÿ

### å†…ç½®æ’ä»¶

#### CPUç›‘æ§æ’ä»¶
- é‡‡é›†ç³»ç»ŸCPUä½¿ç”¨ç‡
- é€šè¿‡è¯»å– `/proc/stat` è·å–æ•°æ®
- æ”¯æŒç”¨æˆ·æ€CPUä½¿ç”¨ç‡ç»Ÿè®¡

#### eBPFç½‘ç»œç›‘æ§æ’ä»¶
- ä½¿ç”¨XDPæŠ€æœ¯ç›‘æ§ç½‘ç»œæµé‡
- å®æ—¶ç»Ÿè®¡ç½‘ç»œåŒ…æ•°é‡
- æ”¯æŒå¤šç½‘å¡ç›‘æ§

### è‡ªå®šä¹‰æ’ä»¶å¼€å‘

å®ç° `pkg/plugin.Plugin` æ¥å£ï¼š

```go
type Plugin interface {
    Name() string
    Config() PluginConfig
    Run(ctx context.Context, out chan<- Event) error
    Stop() error
}
```

æ³¨å†Œæ’ä»¶ï¼š

```go
func init() {
    plugin.Register("my-plugin", New)
}
```

## æ•°æ®ä¼ è¾“åè®®

### Protobufåè®®å®šä¹‰

é¡¹ç›®ä½¿ç”¨Protobuf v3å®šä¹‰æ•°æ®ä¼ è¾“æ ¼å¼ï¼Œæ”¯æŒï¼š

- å•æŒ‡æ ‡ä¼ è¾“ (`Metric`)
- æ‰¹é‡æŒ‡æ ‡ä¼ è¾“ (`BatchMetricsRequest`)
- å¤šç§æŒ‡æ ‡ç±»å‹ï¼ˆCPUã€å†…å­˜ã€ç½‘ç»œç­‰ï¼‰

### QUICä¼ è¾“å±‚

- åŸºäºQUICåè®®å®ç°é«˜æ•ˆä¼ è¾“
- æ”¯æŒè¿æ¥æ± å’Œæµå¤ç”¨
- è‡ªåŠ¨é‡è¿å’Œé”™è¯¯å¤„ç†

## æ€§èƒ½ç‰¹æ€§

### ç¼“å†²åŒºç®¡ç†

- ç¯å½¢ç¼“å†²åŒºè®¾è®¡ï¼Œé¿å…å†…å­˜æ³„æ¼
- æ‰¹é‡å¤„ç†æœºåˆ¶ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
- æ–­ç½‘é‡è¿æ—¶æ•°æ®æŒä¹…åŒ–

### èµ„æºç®¡ç†

- å®æ—¶ç›‘æ§ä»£ç†èµ„æºä½¿ç”¨æƒ…å†µ
- è‡ªåŠ¨é™çº§å’Œç†”æ–­æœºåˆ¶
- ä¼˜é›…çš„å…³é—­å’Œé‡å¯

## å®‰å…¨ç‰¹æ€§

### æƒé™æ§åˆ¶

- æ”¯æŒæƒé™é™çº§ï¼ˆDrop Privilegesï¼‰
- æœ€å°æƒé™åŸåˆ™è¿è¡Œ



## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **eBPFç¼–è¯‘å¤±è´¥**
   - æ£€æŸ¥clang/llvmå®‰è£…
   - ç¡®è®¤å†…æ ¸ç‰ˆæœ¬æ”¯æŒeBPF

3. **ç½‘ç»œè¿æ¥å¤±è´¥**
   - ç¡®è®¤QUICæœåŠ¡å™¨è¿è¡Œ
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
